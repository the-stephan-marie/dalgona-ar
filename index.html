<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR Model Viewer</title>
    
    <!-- Model Viewer Script -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="model-container">
        <model-viewer
            id="model-viewer"
            src="models/Dalgona-OneTake_0004.glb"
            ios-src=""
            alt="Dalgona OneTake Model"
            ar
            ar-modes="webxr scene-viewer quick-look"
            ar-scale="auto"
            ar-placement="floor"
            link="https://www.nescafe.com/mena/en-ae/recipes/nescafe-3in1-dalgona"
            title="Discover 30 days of Nescafe recipes this Ramadan."
            camera-controls
            auto-rotate
            autoplay
            animation-name="animation_0"
            shadow-intensity="1"
            exposure="1"
            environment-image="neutral"
            style="width: 100%; height: 100vh; background-color: #f0f0f0;">
            
            <button slot="ar-button" class="ar-button">
                View in AR
            </button>
            
            <div slot="poster" class="poster">
                <div class="poster-content">
                    <p>Loading 3D Model...</p>
                </div>
            </div>
            
            <!-- WebXR Banner for Android - Must be inside model-viewer -->
            <div id="webxr-banner" class="webxr-banner">
                <div class="banner-content">
                    <div class="banner-text">
                        <h3 class="banner-title">Dalgona Coffee with Nescafe</h3>
                        <p class="banner-subtitle">Discover 30 days of Nescafe recipes this Ramadan.</p>
                    </div>
                    <a href="https://www.nescafe.com/mena/en-ae/recipes/nescafe-3in1-dalgona" 
                       class="banner-button" 
                       id="banner-action-button"
                       target="_blank" 
                       rel="noopener noreferrer">
                        Try Now!
                    </a>
                </div>
            </div>
        </model-viewer>
    </div>

    <!-- AR Session Console -->
    <div id="ar-console" class="ar-console">
        <div class="console-header">
            <h3>AR Session Tracker</h3>
            <button id="console-toggle" class="console-toggle-btn" aria-label="Toggle console">−</button>
        </div>
        <div id="console-content" class="console-content">
            <div class="console-entry console-info">Waiting for AR session...</div>
        </div>
    </div>

    <script>
        // iOS Quick Look Banner Configuration
        const iosBannerConfig = {
            // Generic Banner Options
            callToAction: 'Try Now!',
            checkoutTitle: 'Dalgona Coffee with Nescafe',
            checkoutSubtitle: 'Discover 30 days of Nescafe recipes this Ramadan.',
            price: '',
            canonicalWebPageURL: 'https://www.nescafe.com/mena/en-ae/recipes/nescafe-3in1-dalgona',
            
            // Custom HTML Banner Options (alternative to generic)
            // Uncomment to use custom HTML banner instead
            // custom: 'https://example.com/banner.html',
            // customHeight: 'medium' // small, medium, or large
        };

        // WebXR Banner Configuration for Android
        const webxrBannerConfig = {
            title: 'Dalgona Coffee with Nescafe',
            subtitle: 'Discover 30 days of Nescafe recipes this Ramadan.',
            buttonText: 'Try Now!',
            actionURL: 'https://www.nescafe.com/mena/en-ae/recipes/nescafe-3in1-dalgona'
        };

        // Build iOS USDZ URL with banner parameters
        // CRITICAL: iOS Quick Look requires ABSOLUTE URLs for banner parameters to work
        function buildIOSQuickLookURL() {
            let iosUrl = 'models/Dalgona-OneTake_0004.usdz';
            
            // Convert relative path to absolute URL if needed
            if (!iosUrl.startsWith('http://') && !iosUrl.startsWith('https://')) {
                // Use URL constructor to properly resolve relative paths (handles subdirectories)
                try {
                    iosUrl = new URL(iosUrl, window.location.href).href;
                } catch (e) {
                    // Fallback to manual construction if URL constructor fails
                    const baseUrl = window.location.origin;
                    const path = iosUrl.startsWith('/') ? iosUrl : `/${iosUrl}`;
                    iosUrl = `${baseUrl}${path}`;
                }
            }
            
            const params = [];
            
            // Use custom HTML banner if specified
            if (iosBannerConfig.custom) {
                params.push(`custom=${encodeURIComponent(iosBannerConfig.custom)}`);
                if (iosBannerConfig.customHeight) {
                    params.push(`customHeight=${iosBannerConfig.customHeight}`);
                }
            } else {
                // Use generic banner
                if (iosBannerConfig.callToAction) {
                    params.push(`callToAction=${encodeURIComponent(iosBannerConfig.callToAction)}`);
                }
                if (iosBannerConfig.checkoutTitle) {
                    params.push(`checkoutTitle=${encodeURIComponent(iosBannerConfig.checkoutTitle)}`);
                }
                if (iosBannerConfig.checkoutSubtitle) {
                    params.push(`checkoutSubtitle=${encodeURIComponent(iosBannerConfig.checkoutSubtitle)}`);
                }
                if (iosBannerConfig.price) {
                    params.push(`price=${encodeURIComponent(iosBannerConfig.price)}`);
                }
                if (iosBannerConfig.canonicalWebPageURL) {
                    params.push(`canonicalWebPageURL=${encodeURIComponent(iosBannerConfig.canonicalWebPageURL)}`);
                }
            }
            
            // Append parameters to USDZ URL with #
            if (params.length > 0) {
                iosUrl = `${iosUrl}#${params.join('&')}`;
            }
            
            return iosUrl;
        }

        // Set the iOS source URL with banner parameters
        // CRITICAL: Set ios-src after model-viewer is ready (like working implementation)
        const modelViewer = document.getElementById('model-viewer');
        
        // Wait for model-viewer to be ready before setting ios-src
        if (modelViewer.loaded) {
            modelViewer.setAttribute('ios-src', buildIOSQuickLookURL());
        } else {
            modelViewer.addEventListener('load', () => {
                modelViewer.setAttribute('ios-src', buildIOSQuickLookURL());
            }, { once: true });
        }
        
        // Also set it immediately as fallback
        const iosUrl = buildIOSQuickLookURL();
        console.log('=== iOS Quick Look Banner Debug ===');
        console.log('iOS URL:', iosUrl);
        console.log('URL includes #:', iosUrl.includes('#'));
        console.log('URL includes callToAction:', iosUrl.includes('callToAction'));
        console.log('URL includes canonicalWebPageURL:', iosUrl.includes('canonicalWebPageURL'));
        console.log('Banner config:', iosBannerConfig);
        modelViewer.setAttribute('ios-src', iosUrl);
        
        // Verify the attribute was set
        setTimeout(() => {
            const actualIosSrc = modelViewer.getAttribute('ios-src');
            console.log('Actual ios-src attribute:', actualIosSrc);
            if (actualIosSrc !== iosUrl) {
                console.warn('⚠️ ios-src mismatch! Expected:', iosUrl, 'Got:', actualIosSrc);
            }
        }, 100);

        // Listen for banner tap events
        // Note: This requires the model-viewer to be wrapped in an anchor tag for iOS Quick Look
        // For model-viewer, we need to listen on the model-viewer element itself
        modelViewer.addEventListener('message', function(event) {
            if (event.data === '_apple_ar_quicklook_button_tapped') {
                addConsoleEntry('iOS Quick Look banner tapped', 'success');
                console.log('iOS Quick Look banner tapped!');
                // Handle banner tap - redirect or perform action
                // You can customize this behavior
                if (iosBannerConfig.canonicalWebPageURL) {
                    // Optionally redirect or perform custom action
                    // window.location.href = iosBannerConfig.canonicalWebPageURL;
                }
            }
        }, false);

        // ============================================
        // ON-SCREEN CONSOLE FOR AR SESSION TRACKING
        // ============================================
        
        const arConsole = document.getElementById('ar-console');
        const consoleContent = document.getElementById('console-content');
        const consoleToggleBtn = document.getElementById('console-toggle');
        let consoleVisible = false;
        const MAX_CONSOLE_ENTRIES = 50;
        
        function addConsoleEntry(message, type = 'info') {
            if (!consoleContent) return;
            
            const entry = document.createElement('div');
            entry.className = `console-entry console-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'log-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;
            
            const messageSpan = document.createElement('span');
            if (typeof message === 'object') {
                messageSpan.textContent = JSON.stringify(message, null, 2);
            } else {
                messageSpan.textContent = String(message);
            }
            
            entry.appendChild(timestampSpan);
            entry.appendChild(messageSpan);
            consoleContent.insertBefore(entry, consoleContent.firstChild);
            
            // Keep only last N entries
            const entries = consoleContent.querySelectorAll('.console-entry');
            if (entries.length > MAX_CONSOLE_ENTRIES) {
                entries[entries.length - 1].remove();
            }
            
            // Auto-scroll to top (newest entries)
            consoleContent.scrollTop = 0;
        }
        
        function toggleConsole() {
            if (!arConsole) return;
            
            consoleVisible = !consoleVisible;
            
            if (consoleVisible) {
                arConsole.classList.add('console-expanded');
                consoleToggleBtn.textContent = '−';
                consoleToggleBtn.setAttribute('aria-label', 'Hide console');
            } else {
                arConsole.classList.remove('console-expanded');
                consoleToggleBtn.textContent = '+';
                consoleToggleBtn.setAttribute('aria-label', 'Show console');
            }
        }
        
        // Initialize console toggle
        if (consoleToggleBtn) {
            consoleToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleConsole();
            });
        }
        
        // Make console header clickable to toggle
        const consoleHeader = arConsole?.querySelector('.console-header');
        if (consoleHeader) {
            consoleHeader.addEventListener('click', (e) => {
                if (e.target !== consoleToggleBtn && !consoleToggleBtn.contains(e.target)) {
                    e.stopPropagation();
                    toggleConsole();
                }
            });
        }
        
        // Prevent console clicks from interfering with AR
        if (arConsole) {
            ['click', 'touchstart', 'touchend'].forEach(eventType => {
                arConsole.addEventListener(eventType, function(event) {
                    event.stopPropagation();
                }, { capture: true });
            });
        }
        
        // Initial console entry
        addConsoleEntry('AR Session Tracker initialized', 'info');

        // Listen for AR session events
        modelViewer.addEventListener('ar-status', function(event) {
            const status = event.detail.status;
            const mode = event.detail.mode || 'unknown';
            const banner = document.getElementById('webxr-banner');
            
            // Log to on-screen console
            addConsoleEntry(`AR Status: ${status} | Mode: ${mode}`, 'info');
            
            console.log('AR Status:', status, 'Mode:', mode, 'Banner element:', banner);
            
            // Show banner when WebXR AR session is active
            // WebXR runs in browser, so HTML overlays work
            // Quick Look and Scene Viewer are native apps, so HTML overlays don't work
            if (status === 'session-started' || status === 'object-placed' || status === 'presenting') {
                // Check if it's WebXR mode
                const isWebXR = mode === 'webxr' || (!mode && status === 'presenting');
                
                console.log('AR active - isWebXR:', isWebXR, 'status:', status, 'mode:', mode);
                
                // Log to console
                if (status === 'session-started') {
                    addConsoleEntry('✅ AR session started', 'success');
                } else if (status === 'object-placed') {
                    addConsoleEntry('✅ AR object placed', 'success');
                } else if (status === 'presenting') {
                    addConsoleEntry('✅ AR presenting', 'success');
                }
                
                if (isWebXR && banner) {
                    // Use requestAnimationFrame to ensure overlay container is ready
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            addConsoleEntry('Showing WebXR banner overlay', 'info');
                            console.log('Showing WebXR banner');
                            banner.style.display = 'flex';
                            banner.style.position = 'fixed';
                            banner.style.bottom = '20px';
                            banner.style.left = '50%';
                            banner.style.transform = 'translateX(-50%)';
                            banner.style.zIndex = '99999';
                            banner.style.visibility = 'visible';
                            banner.style.opacity = '1';
                            banner.style.width = '90%';
                            banner.style.maxWidth = '500px';
                            banner.style.background = 'white';
                            banner.style.padding = '16px 20px';
                            banner.style.borderRadius = '10px';
                            banner.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.2)';
                        });
                    });
                } else {
                    // Hide for native AR apps (Quick Look, Scene Viewer)
                    addConsoleEntry(`Native AR mode (${mode}) - HTML overlays not available`, 'warn');
                    console.log('Hiding banner - not WebXR mode');
                    if (banner) banner.style.display = 'none';
                }
            } else if (status === 'not-presenting') {
                addConsoleEntry('AR session ended - not presenting', 'info');
                console.log('Hiding banner - AR session ended');
                if (banner) banner.style.display = 'none';
            } else if (status === 'session-ended') {
                addConsoleEntry('AR session ended', 'info');
                if (banner) banner.style.display = 'none';
            } else if (status === 'failed') {
                addConsoleEntry('❌ AR session failed', 'error');
                if (banner) banner.style.display = 'none';
            }
        });

        // Update WebXR banner content
        function updateWebXRBanner() {
            const bannerTitle = document.querySelector('.banner-title');
            const bannerSubtitle = document.querySelector('.banner-subtitle');
            const bannerButton = document.getElementById('banner-action-button');
            
            if (bannerTitle) bannerTitle.textContent = webxrBannerConfig.title;
            if (bannerSubtitle) bannerSubtitle.textContent = webxrBannerConfig.subtitle;
            if (bannerButton) bannerButton.textContent = webxrBannerConfig.buttonText;
        }

        // Handle WebXR banner button click
        // Prevent clicks on banner from bubbling to viewer
        const banner = document.getElementById('webxr-banner');
        if (banner) {
            banner.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        }

        // Initialize banner content
        updateWebXRBanner();
        
        // Debug: Log banner setup
        const bannerElement = document.getElementById('webxr-banner');
        console.log('=== WebXR Banner Debug ===');
        console.log('Banner element:', bannerElement);
        console.log('Banner parent:', bannerElement?.parentElement);
        console.log('Banner is inside model-viewer:', modelViewer.contains(bannerElement));
        console.log('Banner computed display:', bannerElement ? window.getComputedStyle(bannerElement).display : 'N/A');
        console.log('Model viewer AR available:', modelViewer.arAvailable);
        console.log('Model viewer AR modes:', modelViewer.arModes);

        // Monitor visibility changes to hide banner when user leaves (e.g., to native AR app)
        document.addEventListener('visibilitychange', function() {
            const banner = document.getElementById('webxr-banner');
            if (document.hidden) {
                // Page is hidden - likely user went to native AR app
                if (banner) banner.style.display = 'none';
            }
        });
        
        // Additional check: Monitor AR mode changes
        modelViewer.addEventListener('ar-mode', function(event) {
            const mode = event.detail;
            addConsoleEntry(`AR Mode changed: ${mode}`, 'info');
            console.log('AR Mode changed:', mode);
            const banner = document.getElementById('webxr-banner');
            if (mode === 'webxr' && banner) {
                // Ensure banner is visible for WebXR
                setTimeout(() => {
                    if (modelViewer.getAttribute('ar-status') === 'presenting' || 
                        modelViewer.getAttribute('ar-status') === 'session-started') {
                        banner.style.display = 'flex';
                    }
                }, 100);
            }
        });
        
        // Log AR availability on load
        modelViewer.addEventListener('load', () => {
            addConsoleEntry(`Model loaded | AR Available: ${modelViewer.arAvailable}`, 'info');
            addConsoleEntry(`AR Modes: ${modelViewer.arModes?.join(', ') || 'none'}`, 'info');
        });
    </script>
</body>
</html>

